<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zona de invitados - Agenda</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <header>
    <h1>Bienvenido a la zona de invitados</h1>
  </header>
  <main>
    <section id="infoAgenda">
      <h2><i class="fas fa-calendar-alt"></i> Agenda de Eventos</h2>
      <p class="section-description">
        Confirma tu asistencia a cada uno de los eventos de nuestra boda. 
        Puedes asistir a todos o solo a los que prefieras.
      </p>
      <div id="agendaContent" class="agenda-container"></div>
      <div id="agendaMessage" class="message"></div>
    </section>
  </main>

  <script>
    // Simular token de invitado para pruebas
    const token = 'test-token-123';

    // Función para mostrar mensajes
    function showMessage(elementId, msg, type = 'error') {
      const element = document.getElementById(elementId);
      element.textContent = msg;
      element.className = `message ${type}`;
      element.style.display = 'block';
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }

    // Función para cargar agenda
    async function cargarAgenda() {
      try {
        console.log('Cargando agenda...');
        const agendaRes = await fetch('/api/agenda');
        console.log('Respuesta agenda:', agendaRes);
        
        if (agendaRes.ok) {
          const agenda = await agendaRes.json();
          console.log('Agenda recibida:', agenda);
          
          const agendaDiv = document.getElementById('agendaContent');
          console.log('Div de agenda encontrado:', agendaDiv);
          
          if (!agendaDiv) {
            console.error('No se encontró el elemento agendaContent');
            showMessage('agendaMessage', 'Error: No se encontró el contenedor de agenda', 'error');
            return;
          }
          
          // Agrupar eventos por día
          console.log('Agrupando eventos por día...');
          const eventosPorDia = {};
          agenda.forEach(evento => {
            if (!eventosPorDia[evento.dia]) {
              eventosPorDia[evento.dia] = [];
            }
            eventosPorDia[evento.dia].push(evento);
          });
          
          console.log('Eventos agrupados:', eventosPorDia);

          let agendaHTML = '';
          
          Object.keys(eventosPorDia).forEach(dia => {
            agendaHTML += `
              <div class="agenda-dia">
                <h3 class="dia-titulo">
                  <i class="fas fa-calendar-day"></i>
                  ${dia}
                </h3>
                <div class="eventos-del-dia">
            `;
            
            eventosPorDia[dia].forEach(evento => {
              agendaHTML += `
                <div class="evento-item pendiente" data-evento-id="${evento.id}">
                  <div class="evento-header">
                    <div class="evento-info">
                      <div class="evento-hora">
                        <i class="fas fa-clock"></i>
                        ${evento.hora}
                      </div>
                      <div class="evento-titulo">
                        <i class="fas fa-star"></i>
                        ${evento.evento}
                      </div>
                      <div class="evento-lugar">
                        <i class="fas fa-map-marker-alt"></i>
                        ${evento.lugar}
                      </div>
                      <div class="evento-descripcion">
                        ${evento.descripcion}
                      </div>
                    </div>
                    <div class="event-state">
                      <span class="status-badge pendiente">
                        <i class="fas fa-question-circle"></i>
                        Pendiente
                      </span>
                    </div>
                  </div>
                  <div class="evento-acciones">
                    <button class="btn-confirmar" onclick="confirmarEvento(${evento.id}, true)">
                      <i class="fas fa-check"></i>
                      Confirmar asistencia
                    </button>
                    <button class="btn-cancelar" onclick="confirmarEvento(${evento.id}, false)">
                      <i class="fas fa-times"></i>
                      No asistiré
                    </button>
                  </div>
                </div>
              `;
            });
            
            agendaHTML += `
                </div>
              </div>
            `;
          });
          
          console.log('HTML generado:', agendaHTML);
          agendaDiv.innerHTML = agendaHTML;
          showMessage('agendaMessage', 'Agenda cargada correctamente', 'success');
        } else {
          console.error('Error en la respuesta:', agendaRes.status, agendaRes.statusText);
          showMessage('agendaMessage', 'No se pudo cargar la agenda.', 'error');
        }
      } catch (err) {
        console.error('Error de conexión:', err);
        showMessage('agendaMessage', 'Error de conexión al cargar la agenda.', 'error');
      }
    }

    // Función global para confirmar eventos
    window.confirmarEvento = async (eventoId, confirmado) => {
      try {
        const res = await fetch('/api/agenda/confirmar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': token
          },
          body: JSON.stringify({ eventoId, confirmado })
        });
        
        const data = await res.json();
        if (res.ok) {
          showMessage('agendaMessage', data.mensaje, 'success');
          // Recargar la agenda para mostrar los cambios
          setTimeout(cargarAgenda, 1000);
        } else {
          showMessage('agendaMessage', data.error || 'Error al confirmar el evento.', 'error');
        }
      } catch (err) {
        showMessage('agendaMessage', 'Error de conexión al confirmar el evento.', 'error');
      }
    };

    // Cargar agenda al iniciar
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Página cargada, iniciando carga de agenda...');
      cargarAgenda();
    });
  </script>
</body>
</html> 